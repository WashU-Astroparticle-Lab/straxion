import numpy as np
import matplotlib.colors as mcolors

# Common senses.
SECOND_TO_NANOSECOND = 1_000_000_000

# Common dtype constants for waveform records.
TIME_DTYPE = np.int64
LENGTH_DTYPE = np.int64
CHANNEL_DTYPE = np.int16
DATA_DTYPE = np.dtype("f4")
INDEX_DTYPE = np.int32

# Placeholder index for not found items (will raise IndexError if used).
NOT_FOUND_INDEX = 999_999_999

# Baseline monitor interval.
N_BASELINE_MONITOR_INTERVAL = 100

# Pulse template with sampling rate of 38 kHz.
PULSE_TEMPLATE_38kHz = np.array(
    [
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        7.67229793e-11,
        6.30287041e-10,
        1.18385110e-09,
        1.73741517e-09,
        3.49320597e-09,
        5.31580764e-09,
        7.13840932e-09,
        8.96101099e-09,
        1.07836127e-08,
        1.26062143e-08,
        1.44288160e-08,
        1.62514177e-08,
        1.80740194e-08,
        1.98966210e-08,
        2.17192227e-08,
        2.35418244e-08,
        9.13963040e-08,
        3.33344214e-07,
        5.75292124e-07,
        8.17240034e-07,
        1.05918794e-06,
        1.30113585e-06,
        1.54000000e-06,
        1.52620304e-06,
        1.51240607e-06,
        1.49860911e-06,
        1.48481215e-06,
        1.45185813e-06,
        1.41864280e-06,
        1.39845364e-06,
        1.37826449e-06,
        1.34238276e-06,
        1.27737916e-06,
        1.19468282e-06,
        1.13885250e-06,
        1.11129745e-06,
        1.08374241e-06,
        1.05552810e-06,
        1.02314470e-06,
        9.90761297e-07,
        9.70761563e-07,
        9.52296825e-07,
        9.33832088e-07,
        9.15367351e-07,
        8.86649130e-07,
        8.52636824e-07,
        8.19743770e-07,
        8.04672082e-07,
        7.89600394e-07,
        7.74528706e-07,
        7.59457019e-07,
        7.35894247e-07,
        7.12242341e-07,
        6.88590435e-07,
        6.68378415e-07,
        6.50581378e-07,
        6.32784342e-07,
        6.14987305e-07,
        5.97190268e-07,
        5.81916113e-07,
        5.67469597e-07,
        5.53023080e-07,
        5.38576564e-07,
        5.24130047e-07,
        5.12299760e-07,
        5.00472055e-07,
        4.88644349e-07,
        4.76816643e-07,
        4.64988938e-07,
        4.53161232e-07,
        4.41575446e-07,
        4.30009100e-07,
        4.18442754e-07,
        4.06876408e-07,
        3.95310062e-07,
        3.83743716e-07,
        3.73052682e-07,
        3.64325144e-07,
        3.55597605e-07,
        3.46870066e-07,
        3.38142528e-07,
        3.29414989e-07,
        3.20687450e-07,
        3.11959912e-07,
        3.02686261e-07,
        2.92725198e-07,
        2.82764135e-07,
        2.72803072e-07,
        2.62842009e-07,
        2.52880946e-07,
        2.42919883e-07,
        2.34039966e-07,
        2.29742020e-07,
        2.25444073e-07,
        2.21146126e-07,
        2.16848180e-07,
        2.12550233e-07,
        2.08252286e-07,
        2.03954340e-07,
        1.99656393e-07,
        1.95358446e-07,
        1.91060500e-07,
        1.86762553e-07,
        1.83491666e-07,
        1.80594526e-07,
        1.77697385e-07,
        1.74800245e-07,
        1.71903104e-07,
        1.69005964e-07,
        1.66108823e-07,
        1.63211683e-07,
        1.60314542e-07,
        1.57417402e-07,
        1.54520261e-07,
        1.51623121e-07,
        1.48725980e-07,
        1.45716230e-07,
        1.42022358e-07,
        1.38328487e-07,
        1.34634616e-07,
        1.30940744e-07,
        1.27246873e-07,
        1.23553001e-07,
        1.19859130e-07,
        1.16165258e-07,
        1.12471387e-07,
        1.08777515e-07,
        1.05083644e-07,
        1.01389772e-07,
        9.80586797e-08,
        9.58204444e-08,
        9.35822092e-08,
        9.13439740e-08,
        8.91057387e-08,
        8.68675035e-08,
        8.46292682e-08,
        8.23910330e-08,
        8.01527978e-08,
        7.79145625e-08,
        7.56763273e-08,
        7.34380921e-08,
        7.11998568e-08,
        6.90501312e-08,
        6.70597473e-08,
        6.50693634e-08,
        6.30789795e-08,
        6.10885955e-08,
        5.90982116e-08,
        5.71078277e-08,
        5.51174438e-08,
        5.31270599e-08,
        5.11366759e-08,
        4.91462920e-08,
        4.71559081e-08,
        4.51655242e-08,
        4.37894263e-08,
        4.31201107e-08,
        4.24507950e-08,
        4.17814793e-08,
        4.11121637e-08,
        4.04428480e-08,
        3.97735324e-08,
        3.91042167e-08,
        3.84349010e-08,
        3.77655854e-08,
        3.70962697e-08,
        3.64269540e-08,
        3.57576384e-08,
        3.50827527e-08,
        3.44037141e-08,
        3.37246755e-08,
        3.30456369e-08,
        3.23665983e-08,
        3.16875598e-08,
        3.10085212e-08,
        3.03294826e-08,
        2.96504440e-08,
        2.89714054e-08,
        2.82923668e-08,
        2.76133283e-08,
        2.69342897e-08,
        2.68937332e-08,
        2.71525903e-08,
        2.74114474e-08,
        2.76703045e-08,
        2.79291616e-08,
        2.81880187e-08,
        2.84468758e-08,
        2.87057329e-08,
        2.89645900e-08,
        2.92234471e-08,
        2.94823042e-08,
        2.97411613e-08,
        3.00000184e-08,
        2.95897779e-08,
        2.90002202e-08,
        2.84106625e-08,
        2.78211048e-08,
        2.72315471e-08,
        2.66419894e-08,
        2.60524316e-08,
        2.54628739e-08,
        2.48733162e-08,
        2.42837585e-08,
        2.36942008e-08,
        2.31046431e-08,
        2.25150854e-08,
        2.19377042e-08,
        2.13617284e-08,
        2.07857526e-08,
        2.02097768e-08,
        1.96338010e-08,
        1.90578251e-08,
        1.84818493e-08,
        1.79058735e-08,
        1.73298977e-08,
        1.67539219e-08,
        1.61779461e-08,
        1.56019702e-08,
        1.50256153e-08,
        1.43637284e-08,
        1.37018416e-08,
        1.30399547e-08,
        1.23780678e-08,
        1.17161809e-08,
        1.10542940e-08,
        1.03924071e-08,
        9.73052025e-09,
        9.06863337e-09,
        8.40674648e-09,
        7.74485960e-09,
        7.08297272e-09,
        6.48802803e-09,
        6.42225935e-09,
        6.35649066e-09,
        6.29072198e-09,
        6.22495330e-09,
        6.15918462e-09,
        6.09341593e-09,
        6.02764725e-09,
        5.96187857e-09,
        5.89610989e-09,
        5.83034120e-09,
        5.76457252e-09,
        5.69880384e-09,
        5.55058914e-09,
        5.11037391e-09,
        4.67015868e-09,
        4.22994345e-09,
        3.78972822e-09,
        3.34951299e-09,
        2.90929776e-09,
        2.46908253e-09,
        2.02886730e-09,
        1.58865207e-09,
        1.14843684e-09,
        7.08221605e-10,
        2.68006374e-10,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
        0.00000000e00,
    ]
)
PULSE_TEMPLATE_LENGTH = len(PULSE_TEMPLATE_38kHz)
PULSE_TEMPLATE_ARGMAX = np.argmax(PULSE_TEMPLATE_38kHz)

# Hit waveform recording window length.
HIT_WINDOW_LENGTH_LEFT = 200
HIT_WINDOW_LENGTH_RIGHT = 600

# Energy resolution constants for truth generation.
# Reference photon energy and dx values for 25um wavelength
PHOTON_25um_meV = 50  # meV
PHOTON_25um_DX = 1.54e-6  # dx units
# Energy resolution in dx units (optimistic and conservative modes)
DX_RESOL_OPTIMISTIC = 186835.48206306322e-12
DX_RESOL_CONSERVATIVE = 267423.0098878706e-12

# Noise PSD
NOISE_PSD_38kHz = [
    7.26694760e-10,
    5.46656831e-10,
    4.09441619e-10,
    3.14777288e-10,
    2.42728754e-10,
    1.99305780e-10,
    1.65945369e-10,
    1.40447431e-10,
    1.23387758e-10,
    1.12028470e-10,
    1.01342455e-10,
    9.34183564e-11,
    8.61392763e-11,
    8.21043927e-11,
    7.97335045e-11,
    7.48825515e-11,
    7.16410403e-11,
    6.72483805e-11,
    6.63771121e-11,
    6.24026039e-11,
    6.23842436e-11,
    5.91304436e-11,
    5.80822994e-11,
    5.53993761e-11,
    5.55595812e-11,
    5.19006019e-11,
    5.21635443e-11,
    4.94040989e-11,
    4.82446999e-11,
    4.90731206e-11,
    4.65732800e-11,
    4.51908684e-11,
    4.37259846e-11,
    4.37036345e-11,
    4.17650116e-11,
    4.15335058e-11,
    4.00780346e-11,
    3.98396038e-11,
    3.95915106e-11,
    3.82403727e-11,
    3.76873879e-11,
    3.70541514e-11,
    3.54601834e-11,
    3.52872523e-11,
    3.45467266e-11,
    3.38692720e-11,
    3.33207489e-11,
    3.27488175e-11,
    3.21356414e-11,
    3.20228670e-11,
    3.06850413e-11,
    3.01817599e-11,
    2.94737776e-11,
    3.01170651e-11,
    2.86906974e-11,
    2.80579674e-11,
    2.88176358e-11,
    2.76381418e-11,
    2.67587012e-11,
    2.67952553e-11,
    2.60763078e-11,
    2.55269972e-11,
    2.50649796e-11,
    2.48390180e-11,
    2.42029296e-11,
    2.42456905e-11,
    2.35525991e-11,
    2.34520164e-11,
    2.34324296e-11,
    2.30015451e-11,
    2.30619707e-11,
    2.20900798e-11,
    2.16366144e-11,
    2.15199143e-11,
    2.10161229e-11,
    2.11087953e-11,
    2.03332212e-11,
    1.99906966e-11,
    2.00871039e-11,
    1.96745086e-11,
    1.92227102e-11,
    1.91056910e-11,
    1.87244005e-11,
    1.85107606e-11,
    1.81050834e-11,
    1.79904841e-11,
    1.76668836e-11,
    1.75384585e-11,
    1.77986289e-11,
    1.73371040e-11,
    1.69635452e-11,
    1.65774321e-11,
    1.65681132e-11,
    1.60312891e-11,
    1.62801942e-11,
    1.57072376e-11,
    1.57781323e-11,
    1.50332281e-11,
    1.53092955e-11,
    1.48469414e-11,
    1.49327582e-11,
    1.46958973e-11,
    1.44278816e-11,
    1.41906322e-11,
    1.41204461e-11,
    1.42020172e-11,
    1.39963189e-11,
    1.34668474e-11,
    1.33430975e-11,
    1.31034445e-11,
    1.31693918e-11,
    1.28086725e-11,
    1.26700976e-11,
    1.25773680e-11,
    1.25320674e-11,
    1.22294215e-11,
    1.24290456e-11,
    1.20079328e-11,
    1.18191212e-11,
    1.16652686e-11,
    1.15634082e-11,
    1.15683565e-11,
    1.14102981e-11,
    1.13801902e-11,
    1.12328948e-11,
    1.13060377e-11,
    1.09818500e-11,
    1.07828789e-11,
    1.07121924e-11,
    1.04721527e-11,
    1.04595820e-11,
    1.02540684e-11,
    1.00919698e-11,
    1.03491009e-11,
    9.89250001e-12,
    1.01300834e-11,
    9.73681812e-12,
    9.79981808e-12,
    9.59207800e-12,
    9.52517492e-12,
    9.20574120e-12,
    9.35137818e-12,
    9.05450021e-12,
    9.17063387e-12,
    9.11706648e-12,
    8.89441038e-12,
    8.75177795e-12,
    8.65420235e-12,
    8.65438884e-12,
    8.66608261e-12,
    8.43727171e-12,
    8.39555942e-12,
    8.38934564e-12,
    8.45009306e-12,
    8.12895758e-12,
    8.00385366e-12,
    8.21720816e-12,
    7.84204732e-12,
    7.88567475e-12,
    7.57711775e-12,
    7.69931688e-12,
    7.57474465e-12,
    7.60266589e-12,
    7.52441946e-12,
    7.44057854e-12,
    7.24660783e-12,
    7.24962234e-12,
    7.13331044e-12,
    6.99216683e-12,
    7.13061381e-12,
    7.11724343e-12,
    6.66927581e-12,
    6.85742999e-12,
    6.88179071e-12,
    6.83090867e-12,
    6.69193130e-12,
    6.62388200e-12,
    6.45056881e-12,
    6.45649506e-12,
    6.50314134e-12,
    6.40293547e-12,
    6.23757946e-12,
    6.20142913e-12,
    6.06432786e-12,
    6.04943613e-12,
    5.95270578e-12,
    5.85953898e-12,
    5.85912091e-12,
    5.91536976e-12,
    5.75995111e-12,
    5.74823782e-12,
    5.74422454e-12,
    5.70128189e-12,
    5.60985980e-12,
    5.69308056e-12,
    5.48015583e-12,
    5.34800112e-12,
    5.46635567e-12,
    5.28396034e-12,
    5.31172935e-12,
    5.14547085e-12,
    5.20066108e-12,
    5.02573807e-12,
    5.00308085e-12,
    4.99835069e-12,
    4.97171922e-12,
    4.93962683e-12,
    4.91933664e-12,
    4.82948794e-12,
    4.69634488e-12,
    4.75212014e-12,
    4.58756384e-12,
    4.59671147e-12,
    4.56851614e-12,
    4.55045680e-12,
    4.46267719e-12,
    4.45927149e-12,
    4.47681042e-12,
    4.35927249e-12,
    4.36585750e-12,
    4.30888485e-12,
    4.28659712e-12,
    4.28613872e-12,
    4.19069467e-12,
    4.12867310e-12,
    4.09539980e-12,
    4.02896336e-12,
    4.02718961e-12,
    3.99327836e-12,
    3.92842920e-12,
    3.97807004e-12,
    3.83281514e-12,
    3.77181142e-12,
    3.72028406e-12,
    3.75731564e-12,
    3.74877039e-12,
    3.70374217e-12,
    3.64968125e-12,
    3.62937718e-12,
    3.48899642e-12,
    3.63284923e-12,
    3.51720346e-12,
    3.43180887e-12,
    3.41490855e-12,
    3.42340414e-12,
    3.36823451e-12,
    3.28253397e-12,
    3.29197477e-12,
    3.30318021e-12,
    3.33057800e-12,
    3.16657508e-12,
    3.07392068e-12,
    3.15074355e-12,
    3.13624278e-12,
    3.05902287e-12,
    3.03198243e-12,
    3.11845797e-12,
    3.01131451e-12,
    2.88605294e-12,
    2.93085933e-12,
    2.94009955e-12,
    2.87943129e-12,
    2.80174712e-12,
    2.83225808e-12,
    2.83804057e-12,
    2.76244782e-12,
    2.78611270e-12,
    2.75100494e-12,
    2.73510338e-12,
    2.63438837e-12,
    2.69977942e-12,
    2.58430798e-12,
    2.54366320e-12,
    2.48902613e-12,
    2.51402957e-12,
    2.45264139e-12,
    2.48161431e-12,
    2.40127623e-12,
    2.46292179e-12,
    2.43069041e-12,
    2.35804215e-12,
    2.35159938e-12,
    2.33073109e-12,
    2.21030572e-12,
    2.28972548e-12,
    2.24928951e-12,
    2.25698258e-12,
    2.20505385e-12,
    2.20601879e-12,
    2.19542592e-12,
    2.16743377e-12,
    2.14532276e-12,
    2.10011826e-12,
    2.07426264e-12,
    2.10931533e-12,
    2.02663082e-12,
    2.04301983e-12,
    2.00178806e-12,
    1.99207187e-12,
    1.98217159e-12,
    1.95565092e-12,
    1.87495830e-12,
    1.91515922e-12,
    1.81598118e-12,
    1.84726778e-12,
    1.83937804e-12,
    1.81459838e-12,
    1.84708585e-12,
    1.82450149e-12,
    1.79031779e-12,
    1.75363034e-12,
    1.74765974e-12,
    1.73091532e-12,
    1.68006201e-12,
    1.68327949e-12,
    1.67794749e-12,
    1.61985345e-12,
    1.64479227e-12,
    1.60057373e-12,
    1.57640318e-12,
    1.57842424e-12,
    1.56963342e-12,
    1.58852022e-12,
    1.48800557e-12,
    1.50031094e-12,
    1.48933567e-12,
    1.47488619e-12,
    1.48705820e-12,
    1.46682796e-12,
    1.41875563e-12,
    1.44807528e-12,
    1.39566006e-12,
    1.43598816e-12,
    1.43508133e-12,
    1.34736287e-12,
    1.41529930e-12,
    1.39268935e-12,
    1.35580241e-12,
    1.37431603e-12,
    1.34214731e-12,
    1.31023024e-12,
    1.31197722e-12,
    1.29603034e-12,
    1.28458420e-12,
    1.24584381e-12,
    1.28439869e-12,
    1.27651264e-12,
    1.26177790e-12,
    1.26306409e-12,
    1.25474620e-12,
    1.18662491e-12,
    1.21142647e-12,
    1.18923176e-12,
    1.18081055e-12,
    1.19988535e-12,
    1.16854844e-12,
    1.16091295e-12,
    1.15000056e-12,
    1.17902162e-12,
    1.15781039e-12,
    1.15686334e-12,
    1.12590048e-12,
    1.10717577e-12,
    1.11300856e-12,
    1.09088693e-12,
    1.10108949e-12,
    1.08443582e-12,
    1.09888043e-12,
    1.06210104e-12,
    1.05476923e-12,
    1.04435286e-12,
    1.05767955e-12,
    1.05639260e-12,
    1.05194315e-12,
    1.03567404e-12,
    1.03906825e-12,
    1.01689360e-12,
    1.06510590e-12,
    1.04515170e-12,
    1.03196206e-12,
    1.01086240e-12,
    1.02727288e-12,
    1.03879839e-12,
    1.00148199e-12,
    9.99122768e-13,
    1.02864820e-12,
    1.01143356e-12,
    9.89135314e-13,
    9.96990359e-13,
    1.01313229e-12,
    9.66798364e-13,
    1.01481833e-12,
    9.89152987e-13,
    9.80662925e-13,
    9.63943335e-13,
    1.00267461e-12,
    1.00240638e-12,
    1.00630181e-12,
    9.71334016e-13,
    9.51186395e-13,
    9.81199063e-13,
    9.51186395e-13,
    9.71334016e-13,
    1.00630181e-12,
    1.00240638e-12,
    1.00267461e-12,
    9.63943335e-13,
    9.80662925e-13,
    9.89152987e-13,
    1.01481833e-12,
    9.66798364e-13,
    1.01313229e-12,
    9.96990359e-13,
    9.89135314e-13,
    1.01143356e-12,
    1.02864820e-12,
    9.99122768e-13,
    1.00148199e-12,
    1.03879839e-12,
    1.02727288e-12,
    1.01086240e-12,
    1.03196206e-12,
    1.04515170e-12,
    1.06510590e-12,
    1.01689360e-12,
    1.03906825e-12,
    1.03567404e-12,
    1.05194315e-12,
    1.05639260e-12,
    1.05767955e-12,
    1.04435286e-12,
    1.05476923e-12,
    1.06210104e-12,
    1.09888043e-12,
    1.08443582e-12,
    1.10108949e-12,
    1.09088693e-12,
    1.11300856e-12,
    1.10717577e-12,
    1.12590048e-12,
    1.15686334e-12,
    1.15781039e-12,
    1.17902162e-12,
    1.15000056e-12,
    1.16091295e-12,
    1.16854844e-12,
    1.19988535e-12,
    1.18081055e-12,
    1.18923176e-12,
    1.21142647e-12,
    1.18662491e-12,
    1.25474620e-12,
    1.26306409e-12,
    1.26177790e-12,
    1.27651264e-12,
    1.28439869e-12,
    1.24584381e-12,
    1.28458420e-12,
    1.29603034e-12,
    1.31197722e-12,
    1.31023024e-12,
    1.34214731e-12,
    1.37431603e-12,
    1.35580241e-12,
    1.39268935e-12,
    1.41529930e-12,
    1.34736287e-12,
    1.43508133e-12,
    1.43598816e-12,
    1.39566006e-12,
    1.44807528e-12,
    1.41875563e-12,
    1.46682796e-12,
    1.48705820e-12,
    1.47488619e-12,
    1.48933567e-12,
    1.50031094e-12,
    1.48800557e-12,
    1.58852022e-12,
    1.56963342e-12,
    1.57842424e-12,
    1.57640318e-12,
    1.60057373e-12,
    1.64479227e-12,
    1.61985345e-12,
    1.67794749e-12,
    1.68327949e-12,
    1.68006201e-12,
    1.73091532e-12,
    1.74765974e-12,
    1.75363034e-12,
    1.79031779e-12,
    1.82450149e-12,
    1.84708585e-12,
    1.81459838e-12,
    1.83937804e-12,
    1.84726778e-12,
    1.81598118e-12,
    1.91515922e-12,
    1.87495830e-12,
    1.95565092e-12,
    1.98217159e-12,
    1.99207187e-12,
    2.00178806e-12,
    2.04301983e-12,
    2.02663082e-12,
    2.10931533e-12,
    2.07426264e-12,
    2.10011826e-12,
    2.14532276e-12,
    2.16743377e-12,
    2.19542592e-12,
    2.20601879e-12,
    2.20505385e-12,
    2.25698258e-12,
    2.24928951e-12,
    2.28972548e-12,
    2.21030572e-12,
    2.33073109e-12,
    2.35159938e-12,
    2.35804215e-12,
    2.43069041e-12,
    2.46292179e-12,
    2.40127623e-12,
    2.48161431e-12,
    2.45264139e-12,
    2.51402957e-12,
    2.48902613e-12,
    2.54366320e-12,
    2.58430798e-12,
    2.69977942e-12,
    2.63438837e-12,
    2.73510338e-12,
    2.75100494e-12,
    2.78611270e-12,
    2.76244782e-12,
    2.83804057e-12,
    2.83225808e-12,
    2.80174712e-12,
    2.87943129e-12,
    2.94009955e-12,
    2.93085933e-12,
    2.88605294e-12,
    3.01131451e-12,
    3.11845797e-12,
    3.03198243e-12,
    3.05902287e-12,
    3.13624278e-12,
    3.15074355e-12,
    3.07392068e-12,
    3.16657508e-12,
    3.33057800e-12,
    3.30318021e-12,
    3.29197477e-12,
    3.28253397e-12,
    3.36823451e-12,
    3.42340414e-12,
    3.41490855e-12,
    3.43180887e-12,
    3.51720346e-12,
    3.63284923e-12,
    3.48899642e-12,
    3.62937718e-12,
    3.64968125e-12,
    3.70374217e-12,
    3.74877039e-12,
    3.75731564e-12,
    3.72028406e-12,
    3.77181142e-12,
    3.83281514e-12,
    3.97807004e-12,
    3.92842920e-12,
    3.99327836e-12,
    4.02718961e-12,
    4.02896336e-12,
    4.09539980e-12,
    4.12867310e-12,
    4.19069467e-12,
    4.28613872e-12,
    4.28659712e-12,
    4.30888485e-12,
    4.36585750e-12,
    4.35927249e-12,
    4.47681042e-12,
    4.45927149e-12,
    4.46267719e-12,
    4.55045680e-12,
    4.56851614e-12,
    4.59671147e-12,
    4.58756384e-12,
    4.75212014e-12,
    4.69634488e-12,
    4.82948794e-12,
    4.91933664e-12,
    4.93962683e-12,
    4.97171922e-12,
    4.99835069e-12,
    5.00308085e-12,
    5.02573807e-12,
    5.20066108e-12,
    5.14547085e-12,
    5.31172935e-12,
    5.28396034e-12,
    5.46635567e-12,
    5.34800112e-12,
    5.48015583e-12,
    5.69308056e-12,
    5.60985980e-12,
    5.70128189e-12,
    5.74422454e-12,
    5.74823782e-12,
    5.75995111e-12,
    5.91536976e-12,
    5.85912091e-12,
    5.85953898e-12,
    5.95270578e-12,
    6.04943613e-12,
    6.06432786e-12,
    6.20142913e-12,
    6.23757946e-12,
    6.40293547e-12,
    6.50314134e-12,
    6.45649506e-12,
    6.45056881e-12,
    6.62388200e-12,
    6.69193130e-12,
    6.83090867e-12,
    6.88179071e-12,
    6.85742999e-12,
    6.66927581e-12,
    7.11724343e-12,
    7.13061381e-12,
    6.99216683e-12,
    7.13331044e-12,
    7.24962234e-12,
    7.24660783e-12,
    7.44057854e-12,
    7.52441946e-12,
    7.60266589e-12,
    7.57474465e-12,
    7.69931688e-12,
    7.57711775e-12,
    7.88567475e-12,
    7.84204732e-12,
    8.21720816e-12,
    8.00385366e-12,
    8.12895758e-12,
    8.45009306e-12,
    8.38934564e-12,
    8.39555942e-12,
    8.43727171e-12,
    8.66608261e-12,
    8.65438884e-12,
    8.65420235e-12,
    8.75177795e-12,
    8.89441038e-12,
    9.11706648e-12,
    9.17063387e-12,
    9.05450021e-12,
    9.35137818e-12,
    9.20574120e-12,
    9.52517492e-12,
    9.59207800e-12,
    9.79981808e-12,
    9.73681812e-12,
    1.01300834e-11,
    9.89250001e-12,
    1.03491009e-11,
    1.00919698e-11,
    1.02540684e-11,
    1.04595820e-11,
    1.04721527e-11,
    1.07121924e-11,
    1.07828789e-11,
    1.09818500e-11,
    1.13060377e-11,
    1.12328948e-11,
    1.13801902e-11,
    1.14102981e-11,
    1.15683565e-11,
    1.15634082e-11,
    1.16652686e-11,
    1.18191212e-11,
    1.20079328e-11,
    1.24290456e-11,
    1.22294215e-11,
    1.25320674e-11,
    1.25773680e-11,
    1.26700976e-11,
    1.28086725e-11,
    1.31693918e-11,
    1.31034445e-11,
    1.33430975e-11,
    1.34668474e-11,
    1.39963189e-11,
    1.42020172e-11,
    1.41204461e-11,
    1.41906322e-11,
    1.44278816e-11,
    1.46958973e-11,
    1.49327582e-11,
    1.48469414e-11,
    1.53092955e-11,
    1.50332281e-11,
    1.57781323e-11,
    1.57072376e-11,
    1.62801942e-11,
    1.60312891e-11,
    1.65681132e-11,
    1.65774321e-11,
    1.69635452e-11,
    1.73371040e-11,
    1.77986289e-11,
    1.75384585e-11,
    1.76668836e-11,
    1.79904841e-11,
    1.81050834e-11,
    1.85107606e-11,
    1.87244005e-11,
    1.91056910e-11,
    1.92227102e-11,
    1.96745086e-11,
    2.00871039e-11,
    1.99906966e-11,
    2.03332212e-11,
    2.11087953e-11,
    2.10161229e-11,
    2.15199143e-11,
    2.16366144e-11,
    2.20900798e-11,
    2.30619707e-11,
    2.30015451e-11,
    2.34324296e-11,
    2.34520164e-11,
    2.35525991e-11,
    2.42456905e-11,
    2.42029296e-11,
    2.48390180e-11,
    2.50649796e-11,
    2.55269972e-11,
    2.60763078e-11,
    2.67952553e-11,
    2.67587012e-11,
    2.76381418e-11,
    2.88176358e-11,
    2.80579674e-11,
    2.86906974e-11,
    3.01170651e-11,
    2.94737776e-11,
    3.01817599e-11,
    3.06850413e-11,
    3.20228670e-11,
    3.21356414e-11,
    3.27488175e-11,
    3.33207489e-11,
    3.38692720e-11,
    3.45467266e-11,
    3.52872523e-11,
    3.54601834e-11,
    3.70541514e-11,
    3.76873879e-11,
    3.82403727e-11,
    3.95915106e-11,
    3.98396038e-11,
    4.00780346e-11,
    4.15335058e-11,
    4.17650116e-11,
    4.37036345e-11,
    4.37259846e-11,
    4.51908684e-11,
    4.65732800e-11,
    4.90731206e-11,
    4.82446999e-11,
    4.94040989e-11,
    5.21635443e-11,
    5.19006019e-11,
    5.55595812e-11,
    5.53993761e-11,
    5.80822994e-11,
    5.91304436e-11,
    6.23842436e-11,
    6.24026039e-11,
    6.63771121e-11,
    6.72483805e-11,
    7.16410403e-11,
    7.48825515e-11,
    7.97335045e-11,
    8.21043927e-11,
    8.61392763e-11,
    9.34183564e-11,
    1.01342455e-10,
    1.12028470e-10,
    1.23387758e-10,
    1.40447431e-10,
    1.65945369e-10,
    1.99305780e-10,
    2.42728754e-10,
    3.14777288e-10,
    4.09441619e-10,
    5.46656831e-10,
]


def base_waveform_dtype():
    """Return the base dtype list for a waveform record, without the data fields.

    Returns:
        list: List of dtype tuples for the base waveform record fields.

    """
    return [
        (("Start time since unix epoch [ns]", "time"), TIME_DTYPE),
        (("Exclusive end time since unix epoch [ns]", "endtime"), TIME_DTYPE),
        (("Length of the interval in samples", "length"), LENGTH_DTYPE),
        (
            ("Width of one sample [ns], which is not exact due to the int conversion", "dt"),
            TIME_DTYPE,
        ),
        (("Channel number defined by channel_map", "channel"), CHANNEL_DTYPE),
    ]


def timestamp_to_nanoseconds(timestamp_str):
    """Convert a timestamp string in format YYYYMMDDHHmmSS to nanoseconds since Unix epoch.

    Args:
        timestamp_str (str): Timestamp string in format YYYYMMDDHHmmSS

    Returns:
        int: Timestamp in nanoseconds since Unix epoch

    Example:
        >>> timestamp_to_nanoseconds("19980717223000")
        900714600000000000

    """
    from datetime import datetime

    # Parse the timestamp string
    dt = datetime.strptime(timestamp_str, "%Y%m%d%H%M%S")

    # Convert to Unix timestamp (seconds since epoch)
    unix_timestamp = dt.timestamp()

    # Convert to nanoseconds
    nanoseconds = int(unix_timestamp * 1_000_000_000)

    return nanoseconds


def circfit(x, y):
    """Least squares fit of X-Y data to a circle.

    Adapted from the Matlab implementation of Andrew D. Horchler (horchler@gmail.com).

    Args:
        x (array-like): 1D array of x position data.
        y (array-like): 1D array of y position data.

    Returns:
        tuple: (x_center, y_center, radius, rms_error)
            x_center (float): X-position of center of fitted circle.
            y_center (float): Y-position of center of fitted circle.
            radius (float): Radius of fitted circle.
            rms_error (float): Root mean squared error of the fit.

    Raises:
        ValueError: If x and y are not the same length, have less than three points,
            or are collinear.

    """
    x = np.asarray(x, dtype=float).flatten()
    y = np.asarray(y, dtype=float).flatten()

    # Sanity checks.
    if x.size != y.size:
        raise ValueError(
            "x and y must be the same length. "
            f"Got x.shape={x.shape}, y.shape={y.shape}, x.size={x.size}, y.size={y.size}"
        )
    if x.size < 3:
        raise ValueError(
            f"At least three points are required. Got x.size={x.size}, y.size={y.size}"
        )

    # Collinearity check.
    collinearity_matrix = np.column_stack([x[: min(50, len(x))], y[: min(50, len(y))]])
    diff_matrix = np.diff(collinearity_matrix, axis=0)
    rank = np.linalg.matrix_rank(diff_matrix)
    if rank == 1:
        raise ValueError(
            f"Points are collinear or nearly collinear.\n"
            f"First 50 (or fewer) x: {x[:min(50, len(x))]}\n"
            f"First 50 (or fewer) y: {y[:min(50, len(y))]}\n"
            f"Collinearity diff matrix shape: {diff_matrix.shape}, rank: {rank}"
        )

    x2 = x * x
    y2 = y * y
    xy = x * y
    sum_x = np.sum(x)
    sum_y = np.sum(y)
    sum_x2 = np.sum(x2)
    sum_y2 = np.sum(y2)
    sum_xy = np.sum(xy)
    sum_x2y = np.sum((x2 + y2) * y)
    sum_x2x = np.sum((x2 + y2) * x)
    sum_x2y2 = np.sum(x2 + y2)
    n_points = len(x)

    # Solve Ax=b.
    a_matrix = np.array(
        [[sum_x, sum_y, n_points], [sum_xy, sum_y2, sum_y], [sum_x2, sum_xy, sum_x]]
    )
    b_vector = np.array([sum_x2y2, sum_x2y, sum_x2x])
    try:
        solution = np.linalg.solve(a_matrix, b_vector)
    except np.linalg.LinAlgError as e:
        raise ValueError(
            f"Failed to solve linear system in circfit.\n"
            f"a_matrix=\n{a_matrix}\n"
            f"b_vector={b_vector}\n"
            f"Error: {e}"
        )
    x_center = 0.5 * solution[0]
    y_center = 0.5 * solution[1]
    radius = np.sqrt(x_center**2 + y_center**2 + solution[2])

    # Root mean squared error.
    # Calculate the distance from each point to the fitted circle center.
    distances = np.sqrt((x - x_center) ** 2 + (y - y_center) ** 2)
    # Compute the RMS error between these distances and the fitted radius.
    rms_error = np.sqrt(np.mean((distances - radius) ** 2))
    return x_center, y_center, radius, rms_error


def register_xenon_colors():
    """Register Xenon color palette as named colors in matplotlib and set as default color cycle.

    This allows you to use colors like color="xenon_blue" in matplotlib plots.
    It also sets the Xenon colors as the default color cycle for automatic coloring.
    Call this function after importing matplotlib but before creating plots.

    Example:
        >>> import matplotlib.pyplot as plt
        >>> import straxion
        >>> straxion.register_xenon_colors()
        >>> plt.plot([1, 2, 3], color="xenon_blue")  # Named color
        >>> plt.plot([1, 2, 3], [1, 4, 2])  # Uses first color in cycle
    """
    import matplotlib.pyplot as plt
    from cycler import cycler

    xenon_colors = {
        "xenon_black": "#000000",
        "xenon_blue": "#4067b1",
        "xenon_light_blue": "#6ccef5",
        "xenon_red": "#B9123E",
        "xenon_yellow": "#ffc74e",
        "xenon_green": "#39a974",
        "xenon_purple": "#8A1859",
        "xenon_silver": "#bfc2c7",
    }

    # Register each color in matplotlib's color registry
    for name, hex_color in xenon_colors.items():
        mcolors.get_named_colors_mapping()[name] = hex_color

    # Set the Xenon colors as the default color cycle
    color_list = [
        "#000000",
        "#4067b1",
        "#6ccef5",
        "#B9123E",
        "#ffc74e",
        "#39a974",
        "#8A1859",
        "#bfc2c7",
    ]
    plt.rcParams["axes.prop_cycle"] = cycler("color", color_list)
